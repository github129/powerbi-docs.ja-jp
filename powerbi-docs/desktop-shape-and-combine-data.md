---
title: 複数のソースのデータの整形と結合
description: このチュートリアルでは、Power BI Desktop でデータの整形と結合を行う方法について説明します
author: davidiseminger
manager: kfile
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-desktop
ms.topic: tutorial
ms.date: 05/08/2019
ms.author: davidi
LocalizationGroup: Transform and shape data
ms.openlocfilehash: 2835dd34ce5ba2d7bc6be8659b87eb1f550fdc28
ms.sourcegitcommit: 60dad5aa0d85db790553e537bf8ac34ee3289ba3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/29/2019
ms.locfileid: "65514589"
---
# <a name="tutorial-shape-and-combine-data-in-power-bi-desktop"></a>チュートリアル:Power BI Desktop でのデータの整形と結合

**Power BI Desktop** を使用すると、さまざまな種類のデータ ソースに接続し、ニーズに合わせてデータを整形し、他のユーザーと共有できるビジュアル レポートを作成できます。 データの *整形* とは、データを変換することです。たとえば、列やテーブルの名前を変更したり、テキストを数値に変更したり、行を削除したり、最初の行をヘッダーとして設定したりします。 データの *結合* とは、複数のデータ ソースに接続して、必要に応じてそれらを整形してから、1 つの便利なクエリに統合することを意味します。

このチュートリアルでは、以下について説明します。

* **クエリ エディター**を使用してデータを整形する
* データ ソースに接続する
* 別のデータ ソースに接続する
* これらのデータ ソースを結合し、レポートで使用するデータ モデルを作成する

このチュートリアルでは、いくつかの最も一般的なタスクに注目しながら、Power BI Desktop を使用したクエリの整形方法を示します。 ここで使用するクエリは、クエリを最初から作成する方法も含めて、「[Power BI Desktop の概要](desktop-getting-started.md)」でより詳しく説明しています。

Power BI Desktop の **クエリ エディター** では、リボンだけでなく右クリック メニューも広く使用することを知っておくと便利です。 **[変換]** リボンで選択できるほとんどの項目は、(列などの) 項目を右クリックし、表示されるメニューからクリックして使用することもできます。

## <a name="shape-data"></a>データの整形
クエリ エディターでデータを整形する際は、(クエリ エディターが行う) 手順ごとの指示を与えて、クエリ エディターが読み込んで表示するデータを調整します。 元のデータ ソースに影響は及びません。この特定のデータ表示のみが調整または *整形* されます。

指定する手順 (テーブル名の変更、データ型の変換、または列の削除など) はクエリ エディターによって記録され、このクエリ エディターがデータ ソースに接続するたびにこれらの手順が実行されます。そうすることで、データは常に指定されたとおりに整形されます。 自分が Power BI Desktop でクエリ エディター機能を使用するたびに、あるいは別のユーザーが **Power BI** サービスなどで共有クエリを使用する場合に、このプロセスが実行されます。 これらの手順は、 **[クエリの設定]** ウィンドウの **[適用される手順]** で順番にキャプチャされます。

次の図は、整形されたクエリを表示した **[クエリの設定]** ウィンドウを示しています。これらの各手順については、以降のいくつかの段落で説明します。

![](media/desktop-shape-and-combine-data/shapecombine_querysettingsfinished2.png)

「[Power BI Desktop の概要](desktop-getting-started.md)」の退職後の生活のデータ (Web データ ソースに接続すると入手できます) を使って、このデータをニーズに合わせて整形しましょう。

まず、等価の要素であるすべてのデータに基づいてランクを計算し、それを既存の列 _Rank_ と比較するカスタム列を追加しましょう。  次の図は **[列の追加]** リボンです。矢印は **[カスタム列]** ボタンを指しています。このボタンをクリックしてカスタム列を追加できます。

![](media/desktop-shape-and-combine-data/shapecombine_customcolumn.png)

**[カスタム列]** ダイアログの **[新しい列名]** に「_New Rank_」と入力し、 **[カスタム列の式]** に次の数式を入力します。

    ([Cost of living] + [Weather] + [Health care quality] + [Crime] + [Tax] + [Culture] + [Senior] + [#"Well-being"]) / 8

_'構文エラーが検出されませんでした'_ というステータス メッセージが表示されたら、 **[OK]** をクリックします。

![](media/desktop-shape-and-combine-data/shapecombine_customcolumndialog.png)

列データの一貫性を保つために、新しい列値を整数に変換しましょう。 列ヘッダーを右クリックして **[型の変更] \> [整数]** の順に選択するだけで変換できます。 

複数の列を選択するには、まず 1 つの列を選択してから、**Shift** キーを押したまま追加の隣接する列を選択します。次に、列ヘッダーを右クリックして選択した列をすべて変更します。 また、**Ctrl** キーを使用すると、隣接していない列を選ぶこともできます。

![](media/desktop-shape-and-combine-data/shapecombine_changetype2.png)

また、 **[変換]** リボンから列のデータ型を*変換*することもできます。 **[変換]** リボンを次に示します。矢印は、現在のデータ型を別のデータ型に変換する **[データ型]** ボタンを指しています。

![](media/desktop-shape-and-combine-data/queryoverview_transformribbonarrow.png)

データに適用されたすべての整形手順が **[クエリの設定]** の **[適用される手順]** に反映されていることにご注意ください。 整形プロセスからいずれかの手順を削除する場合は、手順の左側にある "**X**” を選びます。 次の図の **[適用される手順]** には、これまでの手順が反映されています。すなわち、Web サイトへの接続 ( **ソース** )、テーブルの選択 ( **ナビゲーション** )、およびテーブルの読み込み中にテキスト ベースの数値型の列がクエリ エディターによって *テキスト型* から *整数型* に自動的に変更されたこと ( **型の変更** ) です。 最後の 2 つの手順は、 **[追加されたカスタム]** と **[Changed Type1]** を使用した前述のアクションを示しています。 

![](media/desktop-shape-and-combine-data/shapecombine_appliedstepsearly2.png)

このクエリを処理する前に、データにいくつかの変更を加えて、処理可能な状態にする必要があります。

* *列を削除してランキングを調整する* - **Cost of living** をこの結果の因数にしないことを決定しました。 この列を削除してもデータが変更されないという問題がありますが、この問題は Power BI Desktop を使用して簡単に解決できます。この操作で、クエリの **[適用したステップ]** の優れた機能がわかります。
* *いくつかのエラーを修正する* - 列を削除したので、**New Rank** 列の計算を再調整する必要があります。 数式の変更などが必要です。
* *データを並べ替える* - **New Rank** 列と **Rank** 列に基づいて並べ替えます。 
* *データを置き換える* - ここでは、特定の値を置き換える方法と **[適用したステップ]** を挿入する必要性について特に説明します。
* *テーブル名を変更する* - **Table 0** は役立つ記述子ではありませんが、変更は簡単です。

**Cost of living** 列を削除するには、列を選択し、リボンの **[ホーム]** タブを選択してから、次の図に示すように、 **[列の削除]** を選択します。

![](media/desktop-shape-and-combine-data/shapecombine_removecolumnscostofliving.png)

_New Rank_ の値は変わっていない点に注意してください。これはステップの順序によるものです。 クエリ エディターは手順を順番に記録しますが、互いに独立しているため、順番に並んだそれぞれの**適用される手順**を上下に移動することができます。 いずれかの手順を右クリックすると、次のことを行うことができるメニューが表示されます:**名前の変更**、**削除**、**最後まで** **削除** (現在の手順とそれ以降の手順もすべて削除する)、**上へ移動**、**下へ移動**。 最後のステップ _[削除された列]_ を _[追加されたカスタム]_ ステップのすぐ上に移動します。

![](media/desktop-shape-and-combine-data/shapecombine_movestep.png)

次に _[追加されたカスタム]_ ステップを選択します。 データには、対処する必要がある_エラー_が表示されます。 

![](media/desktop-shape-and-combine-data/shapecombine_error2.png)

各エラーに関する詳細を取得する方法はいくつかあります。 (" **エラー**” という語をクリックせずに) セルを選択するか、" **エラー** ” という語を直接クリックできます。 " *エラー* ” という語を直接クリック **せずに**セルを選択すると、クエリ エディターによってエラー情報がウィンドウの下部に表示されます。

![](media/desktop-shape-and-combine-data/shapecombine_errorinfo2.png)

" *エラー* ” という語を直接クリックすると、クエリによって **[クエリの設定]** ウィンドウに **[適用される手順]** が作成され、エラーに関する情報が表示されます。 このルートには進みたくないので、 **[キャンセル]** を選択します。

エラーを修正するには、_New Rank_ 列を選択し、 **[表示]** リボンを開き、 **[数式バー]** チェックボックスをオンにして、列のデータの数式を表示します。 

![](media/desktop-shape-and-combine-data/shapecombine_formulabar.png)

次に _Cost of living_ パラメーターを削除し、数式を次のように変更して除数を減らすことができます。 

    Table.AddColumn(#"Removed Columns", "New Rank", each ([Weather] + [Health care quality] + [Crime] + [Tax] + [Culture] + [Senior] + [#"Well-being"]) / 7)

数式ボックスの左側にある緑色のチェックマークをオンにするか、**Enter** キーを押すと、データは修正値で置き換えられ、 **[追加されたカスタム]** ステップは*エラーなし*で完了します。

> [!NOTE]
> **エラーの削除**も行えます (リボンまたは右クリック メニューを使用します)。これにより、エラーを含む行がすべて削除されます。 このケースでは、データからすべての行が削除されることになりますが、それは意図する処理ではありません。希望する処理は、すべてのデータをテーブルに保持することです。

次に **New Rank** 列に基づいてデータを並べ替える必要があります。 まず最後に適用されたステップ **[Changed Type1]** を選択して最新のデータを取得します。 次に、**New Rank** 列見出しの横にあるドロップダウンを選択し、 **[昇順で並べ替え]** を選択します。

![](media/desktop-shape-and-combine-data/shapecombine_sort.png)

**New Rank** に従ってデータが並べ替えられます。  ただし、**Rank** 列を見ると、**New Rank** の値が同順の場合にデータが正しく並べ替えられていないことがわかります。 この問題を修正するには、**New Rank** 列を選択し、**数式バー**の数式を次のように変更します。

    = Table.Sort(#"Changed Type1",{{"New Rank", Order.Ascending},{"Rank", Order.Ascending}})

数式ボックスの左側にある緑のチェックマークをオンにするか、**Enter** キーを押すと、_New Rank_ と _Rank_ に従って行が並べ替えられます。

さらに、 **[適用される手順]** 一覧のどの位置にある手順でも選択でき、順番のその地点からデータの整形を続行できます。 新しい手順は、現在選択されている **適用される手順**の直後に自動的に挿入されます。 試しに実行してみましょう。

まず、 **[適用したステップ]** を選択してからカスタム列を追加します。これは _[削除された列]_ ステップになります。 ここでは、アリゾナ州の_気象_ランキングの値を置き換えます。 アリゾナ州の_気象_ランキングを含む適切なセルを右クリックし、表示されるメニューから *[値の置換]* を選択します。 **[適用したステップ]** ( _[追加されたカスタム]_ ステップの前のステップ) が現在選択されています。

![](media/desktop-shape-and-combine-data/shapecombine_replacevalues2.png)

手順を挿入しているので、これ以降の手順によってクエリ エディターが中断する危険があることを示す警告が表示されます。 注意して慎重に操作する必要があります。 これは、手順の作成、削除、挿入、および順序の変更の方法を示してクエリ エディターの非常に優れた機能を強調するためのチュートリアルなので、このまま先に進んで **[挿入]** を選択します。

![](media/desktop-shape-and-combine-data/shapecombine_insertstep.png)

値を _51_ に変更すると、アリゾナ州のデータが置き換えられます。 適用される手順を新規作成すると、クエリ エディターは操作に基づいて手順に名前を付けます。このケースでは "**置換された値**” です。 クエリに同じ名前の手順が複数存在する場合、クエリ エディターは、それらを区別するために、後続の**適用される手順**のそれぞれに対して (順番に) 番号を追加します。

最後の **[適用したステップ]** 、 _[並べ替えられた行]_ を選択すると、アリゾナ州の新しいランキングに関するデータは変更されます。  これは、 _[置換された値]_ ステップが適切な位置 ( _[追加されたカスタム]_ ステップの前) に挿入されたためです。

さて、少し深入りしましたが、これはクエリ エディターがいかに強力で多目的に使えるかを示す良い一例でした。

最後に、このテーブルの名前を分かりやすい名前に変更したいと思います。 レポートを作成することになった場合は、分かりやすいテーブル名を付けると特に役立ちます。とりわけ、複数のデータ ソースに接続し、**レポート** ビューの **[フィールド]** ウィンドウにそれらがすべて一覧表示される場合に役立ちます。

テーブル名の変更は簡単です。次の図のように、 **[クエリの設定]** ウィンドウの **[プロパティ]** で、テーブルの新しい名前を入力し、**Enter** キーを押します。 このテーブルの名前を *RetirementStats* としましょう。

![](media/desktop-shape-and-combine-data/shapecombine_renametable2.png)

これで、データを必要な範囲まで整形しました。 次に、別のデータ ソースに接続し、データを結合しましょう。

## <a name="combine-data"></a>データの結合
さまざまな州に関するこのデータは興味深く、追加の分析作業とクエリの構築に役立ちます。 ただし、1 つ問題があります。ここにあるほとんどのデータでは、州コードの 2 文字の省略形を使用し、州の完全名を使用していません。 何らかの方法により、州名をその省略形に関連付ける必要があります。

幸運にも、ぴったりな別の公共データ ソースがあります。しかし、この退職者テーブルに接続する前に、いくらかの整形を行う必要があります。 州の省略形の Web リソースを次に示します。

<http://en.wikipedia.org/wiki/List_of_U.S._state_abbreviations>

クエリ エディターの **[ホーム]** リボンで、 **[新しいソース] \> [Web]** の順に選択し、アドレスを入力して **[接続]** を選択します。その Web ページの内容がナビゲーターに表示されます。

 ![](media/desktop-shape-and-combine-data/designer_gsg_usstateabbreviationsnavigator2.png)

ここでは **Codes and abbreviations...** を選択します。このテーブルには必要なデータが含まれているためです。しかし、テーブルのデータから余分なものを省いて、必要なものにするにはかなりの作業が必要です。

> [!TIP]
> 次の手順を、より迅速にまたはより簡単に実行する方法はありますか? はい。2 つのテーブル間に *リレーションシップ* を作成し、そのリレーションシップに基づいてデータを整形するという方法があります。 次の手順は、テーブルの操作について学習するのに適しています。リレーションシップにより、複数のテーブルからのデータをすばやく使用できるようになることを理解してください。
> 
> 

このデータを整形するには、次の手順を実行します。

* 先頭の行を削除する - 先頭の行は Web ページのテーブルを作成した方法のために生じたものであり、不要です。 **[ホーム]** リボンで、 **[行の削減] \> [行の削除] \> [上位行の削除]** を選びます。

![](media/desktop-shape-and-combine-data/shapecombine_removetoprows.png)

**[上位行の削除]** ウィンドウが表示され、削除する行数を指定できます。

>[!NOTE]
>Power BI で誤ってテーブル ヘッダーがデータ テーブルの行としてインポートされた場合は、 **[ホーム]** タブまたはリボンの **[変換]** タブから **[先頭の行を見出しとして使用]** を選択してテーブルを修正します。

* 末尾の 26 行を削除する – これらはすべて準州であり、含める必要はありません。 **[ホーム]** リボンで、 **[行の削減] \> [行の削除] \> [下位行の削除]** を選びます。

![](media/desktop-shape-and-combine-data/shapecombine_removebottomrows.png)

* RetirementStats テーブルには Washington DC の情報がないため、一覧からフィルター処理する必要があります。 [地域ステータス] 列の隣にあるドロップダウン矢印を選択し、 **[連邦地区]** の隣にあるチェックボックスの選択を解除します。

![](media/desktop-shape-and-combine-data/shapecombine_filterdc.png)

* いくつかの不要な列を削除する - 州と公式の 2 文字の省略形のマッピングのみが必要であるため、次の列は削除できます: **[列 1]** 、 **[列 3]** 、 **[列 4]** 、 **[列 6]** ～ **[列 11]** 。 まず **[列 1]** を選択してから、**Ctrl** キー を押したまま削除する他の列をクリックします (これにより、複数の連続していない列を選択できます)。 リボンの [ホーム] タブで、 **[列の削除] \> [列の削除]** を選びます。

![](media/desktop-shape-and-combine-data/shapecombine_removecolumns.png)

>[!NOTE]
>ここで、クエリ エディターにおいて適用される手順の*順番*は重要であり、データの整形方法に影響を与えることを指摘しておきます。 また、1 つの手順がこれ以降の別の手順にどのような影響を与える可能性があるかを検討することも重要です。適用される手順から手順を削除すると、クエリの手順の順番による影響のため、これ以降のステップは最初に意図したとおりに動作しない可能性があります。

>[!NOTE]
>クエリ エディター ウィンドウのサイズを変更して幅を狭くすると、表示スペースを最大限利用するようにリボン項目の一部が小さくなります。 クエリ エディター ウィンドウの幅を広げると、広くなったリボン領域を最大限活用するようにリボン項目が拡大されます。

* 列およびテーブル自体の名前を変更する – 通常どおり、列の名前を変更するには 2 つの方法があります。まず列を選んでからリボンの **[変換]** タブで **[名前の変更]** を選ぶか、右クリックしてから表示されるメニューで **[名前の変更...]** を選びます。 次の図では両方のオプションに矢印が付いていますが、選択するのは一方だけです。

![](media/desktop-shape-and-combine-data/shapecombine_rename.png)

名前を " *州名* ” と " *州コード* ” に変更します。 テーブルの名前を変更するには、 **[クエリの設定]** ウィンドウの **[名前]** ボックスに名前を入力します。 このテーブルの名前を " *StateCodes* ” としましょう。

StateCodes テーブルを希望どおりに整形したので、これらの 2 つのテーブルまたはクエリを 1 つに結合します。現在あるテーブルはデータに適用したクエリの結果であるため、"*クエリ*" と呼ばれることがあります。

クエリの結合には、 *マージ* と *追加* という主な 2 つの方法があります。

別のクエリに追加する 1 つ以上の列がある場合は、クエリを **マージ** します。 既存のクエリに追加するデータの追加の行がある場合は、クエリを **追加** します。

ここではクエリをマージします。 最初に、クエリ エディターの左ウィンドウから、 *他のクエリとマージする* クエリを選びます。この場合、「 *RetirementStats* 」です。 次に、リボンの **[ホーム]** タブから **[結合] \> [クエリの結合]** を選びます。

![](media/desktop-shape-and-combine-data/shapecombine_mergequeries.png)

転送対象外のデータを含めたり転送したりせずにデータを結合するため、プライバシー レベルを設定するように求められます。

次に、 **[マージ]** ウィンドウが表示されて、選んだテーブルにマージするテーブルを選んでから、マージに使用する一致する列を選ぶよう求めるメッセージが表示されます。 *RetirementStats* テーブル (クエリ) から州を選びます。次に、*StateCodes* クエリを選びます (この場合は、他のクエリが 1 つのみであるため簡単です。多数のデータ ソースに接続する場合、選択対象のクエリが多数になります)。 一致する列を正しく選ぶと (*RetirementStats* の **[州]** と *StateCodes* の **[州名]** )、 **[マージ]** ウィンドウは次のようになり、 **[OK]** ボタンが有効になります。

![](media/desktop-shape-and-combine-data/shapecombine_merge2.png)

クエリの末尾に **NewColumn** が作成されます。これは、既存のクエリとマージされたテーブル (クエリ) のコンテンツです。 マージされたクエリのすべての列が **NewColumn** に凝縮されますが、テーブルの **[展開]** を選ぶと、必要な列をどれでも含めることができます。

![](media/desktop-shape-and-combine-data/shapecombine_mergenewcolumn.png)

マージされたテーブルを展開して含める列を選ぶには、展開アイコンを選びます (![展開](media/desktop-shape-and-combine-data/icon.png))。 **[展開]** ウィンドウが表示されます。

![](media/desktop-shape-and-combine-data/shapecombine_mergeexpand.png)

このケースでは、 **[州コード]** 列のみが必要であるため、この列のみを選んで **[OK]** を選びます。 [元の列名をプレフィックスとして使用する] のチェックボックスは、不要なためチェックを外します。選んだままにすると、マージされた列の名前は **NewColumn.州コード** (元の列名、または **NewColumn** とドットの後にクエリに含める列の名前を続けたもの) になります。

>[!NOTE]
>**NewColumn** テーブルの導入操作を試してみることができます。 少し実験してみてください。結果に満足できない場合は、 **[クエリの設定]** ウィンドウの **[適用される手順]** の一覧からその手順を削除してください。クエリは、 **[展開]** の手順を適用する前の状態に戻ります。 これは、展開プロセスが希望どおりになるまで何回でも好きなだけ実行できる無料のやり直しのようなものです。

2 つのデータ ソースを結合した 1 つのクエリ (テーブル) ができました。それぞれがニーズに合わせて整形されています。 このクエリは、いずれかの州の住宅費の統計、人口統計、または求人情報など、その他の多くの興味深いデータ接続の基礎となっています。

変更を適用し、クエリ エディターを閉じるには、 **[ホーム]** リボン タブから **[閉じて適用する]** を選択します。変換されたデータセットが Power BI Desktop に表示されます。レポートの作成に利用できます。

![](media/desktop-shape-and-combine-data/shapecombine_closeandapply.png)

## <a name="next-steps"></a>次の手順
Power BI Desktop を使用すると、さまざまなことを行えます。 そのような機能について詳しくは、次のリソースをご覧ください。

* [Power BI Desktop とは何ですか?](desktop-what-is-desktop.md)
* [Power BI Desktop でのクエリの概要](desktop-query-overview.md)
* [Power BI Desktop のデータ ソース](desktop-data-sources.md)
* [Power BI Desktop におけるデータへの接続](desktop-connect-to-data.md)
* [Power BI Desktop での一般的なクエリ タスク](desktop-common-query-tasks.md)   

