---
title: Power BI のパフォーマンスのベスト プラクティス
description: この記事では、Power BI で高速で信頼性の高いレポートを作成するためのベスト プラクティスについて説明します。
author: Bhavik-MSFT
ms.author: bhmerc
manager: kfile
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-service
ms.topic: conceptual
ms.date: 07/30/2018
LocalizationGroup: Reports
ms.openlocfilehash: 736c1ee1b1998ec7f991167352313a05061b3f3c
ms.sourcegitcommit: 226b47f64e6749061cd54bf8d4436f7deaed7691
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/09/2019
ms.locfileid: "70841488"
---
# <a name="power-bi-performance-best-practices"></a>Power BI のパフォーマンスのベスト プラクティス

この記事では、Power BI で高速で信頼性の高いレポートを作成するためのベスト プラクティスについて説明します。  

## <a name="choose-an-appropriate-storage-mode-import-directquery"></a>適切なストレージ モードを選択する: インポート、DirectQuery

ほとんどの場合は、インポート モードが最適な選択肢です。インポート モードでは、単票形式のストレージを使用して圧縮される、ローカルにキャッシュされたメモリ内データを利用することで、最高の速度が提供されます。 インポート モードでは、DAX の完全な機能も使用できます。 ソース データの量が多すぎて Power BI の容量に収まらない場合は、DirectQuery (および複合モデル) を検討します。 DirectQuery は、レポートが読み込まれるたびにソースから最新のデータをフェッチする必要がある場合にも便利です。 これらの要件がなく、ユーザーが 1 日に数回以下しか更新されないデータのみを表示する必要がある場合は (たとえば、企業のデータ ウェアハウスから)、インポートを強くお勧めします。 DirectQuery モードでは、ユーザーは、ソースからまったく同じデータをフェッチしていることに気付かずに、レポートの更新を試みる可能性があります。      

## <a name="use-filters-to-limit-report-visuals-to-display-only-whats-needed"></a>必要なものだけを表示するようにフィルターを使用してレポートのビジュアルを制限する 

ビジュアルで表示しなければならないデータが増えると、ビジュアルの読み込みがそれだけ遅くなります。 これは当然の原則であるように思われますが、忘れがちなことです。 たとえば、大規模なデータセットがあるとします。 そのデータセットの上に、テーブルのテーブルを使用してレポートを構築します。 エンド ユーザーはページ上でスライサーを使用し、必要な行に到達します。通常、エンド ユーザーが関心があるのは数十の行だけです。

よくある間違いは、テーブルの既定のビューをフィルター処理しないことです。つまり、1 億を超えるすべての行が表示されます。 これらの行のデータはメモリに読み込まれ、更新のたびに圧縮解除されます。 この処理により、大量のメモリ負荷が生じます。 解決策: "上位 N" フィルターを使用し、表示されるテーブルの項目の最大数を減らします。 項目の最大数は、ユーザーが必要とする数より大きくする (10,000 など) ことができます。 その結果、エンドユーザー エクスペリエンスが変わることはありませんが、メモリ使用量が大幅に低下します。 また、パフォーマンスが改善されます。

レポートのすべてのビジュアルに対して、上記と同様のアプローチを行うことをお勧めします。 このビジュアルのデータはすべて必要かどうか、 エンドユーザー エクスペリエンスへの影響を最小限に抑えながら、ビジュアルに表示されるデータの量をフィルター処理する方法はありますか。 特にテーブルは高額になる可能性があります。

## <a name="limit-visuals-on-report-pages"></a>レポート ページのビジュアルを制限する

上記の原則は、特定のレポートでのビジュアルの数にも同様に当てはまります。 特定のレポートでのビジュアルの数を必要な分だけに制限することを強くお勧めします。 ドリル スルー ページは、レポートにさらに多くのビジュアルを詰め込むことなく、追加の詳細を提供する優れた方法です。  

## <a name="optimize-your-model"></a>モデルの最適化

ベスト プラクティス:

- 可能な場合、使用されていないテーブルまたは列を削除します。 
- 高いカーディナリティ (数百万の独自の値) を持つフィールドでは重複しない値の数を避けます。  
- 不要な精度と高いカーディナリティを持つフィールドを回避する手順を実行します。 たとえば、一意性の高い datetime 値を月、年、日付など、別々の列に分割できます。 あるいは、可能であれば、高精度フィールドを丸め、カーディナリティを低くします (13.29889 -> 13.3 など)。
- 可能な限り、文字列ではなく整数を使用します。
- テーブル内のすべての行をテストする必要がある DAX 関数 (RANKX など) に注意してください。最悪の場合、テーブル サイズで線形増加が指定されている場合、これらの関数によって実行時間とメモリ要件が指数関数的に増加する可能性があります。
- DirectQuery を使用してデータ ソースに接続するとき、通常再びフィルター処理またはスライスされる列のインデックスを作成することを検討してください。 インデックス作成により、レポートの応答性が大幅に向上します。  

Directquery のデータ ソースの最適化の詳細については、「[DirectQuery in SQL Server 2016 Analysis Services](https://blogs.msdn.microsoft.com/analysisservices/2017/04/06/directquery-in-sql-server-2016-analysis-services-whitepaper/)」 (SQL Server 2016 Analysis Services の DirectQuery) を参照してください。

## <a name="directquery-and-live-connection-understand-underlying-data-source-performance"></a>DirectQuery とライブ接続: 基になるデータ ソースのパフォーマンスを理解する

DirectQuery やライブ接続の場合、ユーザーが Power BI レポートを閲覧すると、Power BI が基になるデータ ソースにリアルタイムにクエリを送信します。 データ ソースからクエリ データが返されると、レポートが表示されます。 結果的に、レポートのパフォーマンスは、基になるデータ ソースのパフォーマンスに大きく依存します。

このような場合、基になるデータ ソースのパフォーマンスを理解することが重要になります。 クエリのパフォーマンスを理解するためのツールは、データ ソースごとに異なります。 たとえば、SQL Server および Azure SQL では、クエリの履歴とそれらの実行時統計を取得するクエリ ストアが用意されています。

DirectQuery とライブ接続上に構築された Power BI レポートをデプロイするときに、エンドユーザーが Power BI Desktop で何をするかを試します。 Power BI Desktop でレポートの読み込みに時間がかかる場合、エンド ユーザーのサービスでも読み込みに時間がかかる可能性が高くなります。 

## <a name="directquery-best-practices"></a>DirectQuery のベスト プラクティス

次のセクションでは、DirectQuery を使用して接続するための一般的なベスト プラクティスについて説明します。

### <a name="db-design-guidance"></a>DB の設計のガイダンス

- 可能な場合、計算列とメジャーをソースにプッシュします。 ソースに近いほど、実行の可能性が高くなります。
- 最適化します。 クエリの実行プランを理解したり、一般的にフィルター処理される列にインデックスを追加したりします。

### <a name="modeling-guidance"></a>モデリングのガイダンス

- Power BI Desktop で開始します。
- クエリ エディターで複雑なクエリを作成しないようにします。
- クエリ エディターで相対日付フィルターは使わないでください。  
- メジャーは、最初は単純にして、徐々に複雑さを追加します。
- 計算列と一意識別子列のリレーションシップは避けます。
- リレーションシップに [参照整合性を想定] を設定してみます。多くの場合、この設定でクエリのパフォーマンスが大幅に向上します。  

### <a name="general"></a>全般

- 最初にフィルターを適用します。
- ビジュアル間の相互作用を無効にすることを検討します。これにより、ユーザーがクロス強調表示するときに、クエリの負荷を軽減できます。
- 上記で説明したように、ビジュアルとビジュアルごとのデータの数を制限します。
- 行レベルのセキュリティを有効にすると、パフォーマンスに大幅な変化が生じる場合があります。 必ず、ユーザーが想定するものと異なる行レベルのセキュリティ ロールをテストしてください。
- 時間のかかるクエリによってシステム リソースが独占されないようにするため、サービスによって強制されるクエリ レベルのタイムアウトがあります。 225 秒より長くかかるクエリはタイムアウトし、ビジュアル レベルのエラーが発生します。

## <a name="understand-dashboards-and-query-caches"></a>ダッシュボードとクエリ キャッシュを理解する

ダッシュボードにピン留めされたビジュアルは、ダッシュボードが読み込まれるときに、クエリ キャッシュによって提供されます。 逆に、レポートを閲覧したときに、データ ソース (インポートの場合は Power BI サービス、または DirectQuery やライブ接続の場合は指定したデータ ソースのどちらか) に対するクエリがその場で作成されます。  

> [!NOTE]
> ライブ レポート タイルをダッシュボードにピン留めするときに、これらのタイルはクエリ キャッシュから提供されるのではなく、レポートと同様に動作し、バックエンド コアに対してその場でクエリを作成します。

名前からわかるように、クエリ キャッシュからデータを取得することで、データ ソースに依存するよりも優れたより一貫性のあるパフォーマンスが実現できます。 この機能を活用するための 1 つの方法は、ダッシュボードをユーザーのための最初のランディング ページにすることです。 よく使用され、頻繁に要求されるビジュアルをダッシュボードにピン留めします。 こうすることで、ダッシュボードが貴重な "防御の最前線" となり、容量への負荷を抑え、一貫したパフォーマンスが実現できます。 ユーザーは引き続き、レポートをクリック スルーして詳細を調べることができます。  
 

DirectQuery とライブ接続では、このクエリ キャッシュはデータ ソースのクエリを実行することで定期的に更新されます。 既定ではこれは 1 時間ごとに行われますが、データセットの設定で構成できます。 各クエリ キャッシュの更新では、基になるデータ ソースにクエリを送信して、キャッシュを更新します。 生成されるクエリの数は、データ ソースに依存するダッシュボードにピン留めされたビジュアルの数によって異なります。 行レベルのセキュリティが有効になっている場合は、異なるセキュリティ コンテキストごとにクエリが生成されることに注意してください。 たとえば、ユーザーが分類される 2 つの異なるロールと、2 つの異なるデータのビューがある場合、クエリ キャッシュの更新中、Power BI により 2 セットのクエリが生成されます。 

## <a name="understand-custom-visual-performance"></a>カスタム ビジュアルのパフォーマンスを理解する 

高パフォーマンスを得るため、必ず各カスタム ビジュアルの性能を試します。 適切に最適化されていないカスタム ビジュアルは、レポート全体のパフォーマンスに悪影響を及ぼす場合があります。 

## <a name="deep-dive-into-query-performance-with-sql-profiler-and-power-bi-desktop"></a>SQL Profiler と Power BI Desktop でのクエリ パフォーマンスをさらに探究する

どのビジュアルが最も多くの時間とリソースを占有しているかをより深く調べるため、SQL Profiler を Power BI Desktop に接続して、クエリ パフォーマンスの全体像を得ることができます。

> [!NOTE]
> Power BI Desktop は、診断ポートへの接続をサポートします。 診断ポートは、その他のツールの接続と、診断目的のトレースの実行を可能にします。 *モデルに対する変更はサポートされていません。モデルに変更を加えると、破損とデータ損失が発生する可能性があります。*

手順は次のとおりです。
  
1. **SQL Server Profiler をインストールし、Power BI Desktop を実行する**

   SQL Server Profiler は、SQL Server Management Studio の一部として使用できます。

2. **Power BI Desktop で使用されているポートを決める**

   管理者特権でコマンド プロンプトまたは PowerShell を実行します。 また、netstat を使用し、Power BI Desktop で分析に使用されているポートを見つけます。

   `> netstat -b -n`

   出力には、アプリケーションと、開いているポートの一覧が表示されます。次に例を示します。  

   `TCP    [::1]:55786            [::1]:55830            ESTABLISHED`

   [msmdsrv.exe]

   msmdsrv.exe で使用するポートを検索し、後で使用するために書きとめます。 この場合、ポート 55786 を使用します。
3. **SQL Server Profiler を Power BI Desktop に接続する**

   - **[スタート]** メニューから SQL Server Profiler を起動する
   - **[ファイル]**  >  **[新しいトレース]**
   - サーバーの種類:Analysis Services
   - サーバー名: localhost:[上記で見つかったポート番号]
   - 次の画面で、 **[実行]** を選択
   - これで SQL Profiler がライブになり、Power BI Desktop が送信するクエリをアクティブにプロファイリングします。 
   - クエリが実行されると、クエリのそれぞれの期間および CPU 時間を表示できます。この情報を使用して、ボトルネックとなっているクエリを判断できます。  

SQL Profiler を使用することで、最長の CPU 時間を消費するクエリを特定できます。 そのクエリがおそらく、パフォーマンスのボトルネックになっています。 最適化を続けるとき、そのようなクエリを実行するビジュアルに注目してください。

## <a name="gateway-best-practices"></a>ゲートウェイのベスト プラクティス

オンプレミスのデータ ゲートウェイは、Power BI サービスと自身のオンプレミスのデータを接続するための優れたツールです。 同時に、計画が不十分な場合には、レポートのパフォーマンスのボトルネックとなることもあります。 すべてのクエリとクエリの応答がゲートウェイを介して渡される DirectQuery/ライブ接続データセットの場合は、特にその傾向が高くなります。 高パフォーマンスのゲートウェイを確保するためのいくつかのベスト プラクティスを次に示します。 

- 個人用モードではなく、**エンタープライズ モードを使用**する。
- **ゲートウェイのハードウェアの推奨仕様**: 8 CPU コア、16 GB の RAM。
- **監視の設定** - ゲートウェイ コンピューターにパフォーマンスの監視を設定し、ゲートウェイが過負荷になり、ボトルネックとなっているかどうかを理解します。 詳細については、「[オンプレミス データ ゲートウェイのトラブルシューティング](service-gateway-onprem-tshoot.md)」をご覧ください。
- **スケール アップまたはスケール アウト** - ゲートウェイが実際にボトルネックになっている場合、スケール アップ (つまり、CPU と RAM が多い、よりパワフルなコンピューターにゲートウェイを移動する)、またはスケール アウト (たとえば、データセットを複数のゲートウェイに分割する) することを検討してください。 
- **インポートとDirectQuery の分離** - スケール アウトする場合は、インポートを担当するゲートウェイと DirectQuery を担当するゲートウェイを分離することを検討します。

## <a name="network-latency"></a>ネットワーク待機時間

ネットワーク待機時間は、要求が Power BI サービスに到達するまでに要する時間と、応答の配信に要する時間が増えることで、レポートのパフォーマンスに影響を及ぼす可能性があります。 Power BI のテナントには、特定のリージョンが割り当てられています。 自分のテナントの "ホーム" 領域を表示するには、powerbi.com に移動して、右上にある **[?]** を選択し、 **[Power BI について]** を選択します。 テナントのユーザーが Power BI サービスにアクセスすると、要求は常にこのリージョンにルーティングされます。 要求が Power BI サービスに到達すると、サービスが追加の要求を (基になるデータ ソースやゲートウェイなどに) 送信することがあり、これもネットワーク待機時間に影響します。

[Azure Speed Test](http://azurespeedtest.azurewebsites.net/) などのツールによって、クライアントと Azure リージョン間のネットワーク待機時間の表示が提供されます。 一般に、ネットワーク待機時間の影響を最小限に抑えるには、データ ソース、ゲートウェイ、および Power BI クラスターをできるだけ近くに配置するようにします。 ネットワーク待機時間が問題の場合は、ゲートウェイとデータ ソースを仮想マシンに配置することで、Power BI クラスターにより近い位置に配置してみてください。

ネットワークの待機時間をさらに改善するには、[Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/) の使用を検討してください。これは、クライアントと Azure データ センター間により高速でより信頼性の高い接続を作成することができます。

## <a name="next-steps"></a>次の手順

- Power BI の大規模なデプロイに関する総合的なガイダンスを使用して、[Power BI Enterprise のデプロイを計画する](https://aka.ms/pbienterprisedeploy)
- [SQL Server 2016 Analysis Services の DirectQuery](https://blogs.msdn.microsoft.com/analysisservices/2017/04/06/directquery-in-sql-server-2016-analysis-services-whitepaper/)
- [[YouTube] Power BI で高速で信頼性の高いレポートを作成する](https://www.youtube.com/watch?v=GhiJABR7XX0)
- [[YouTube] Power BI Enterprise のデプロイ](https://www.youtube.com/watch?v=K-zEWICvICM)
